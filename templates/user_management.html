<!DOCTYPE html>
<html lang="en">
<head>
    <!-- // META AND DOCUMENT SETUP // -->
    <!-- This section contains metadata, links to stylesheets, and the page title. -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management - BantayTubig</title>

    <!-- // STYLESHEETS & FONTS // -->
    <!-- 'main.css' for universal styles, 'user_management.css' for page-specific styles. -->
    <link rel="stylesheet" href="{{ url_for('static', filename='main.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='user_management.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <!-- Stylesheet for the Flatpickr date picker library, used in the audit log filter. -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>
<body>

    <!-- // BACKGROUND VIDEO // -->
    <video autoplay muted loop id="backgroundVideo">
        <source src="{{ url_for('static', filename='BantayTubig.mp4') }}" type="video/mp4">
        Your browser does not support the video tag.
    </video>

    <!-- // UNIVERSAL HEADER & SIDEBAR NAVIGATION // -->
    <!-- This structure is consistent across all pages. -->
    <div class="header-top-left">
        <div class="menu-icon">
            &#9776; <!-- Hamburger menu icon -->
        </div>
    </div>

    <!-- Sidebar Menu: A slide-out navigation panel. -->
    {% include '_sidebar.html' %}

    <div class="header-top-right">
        <h1>User Management</h1>
        <div id="timestamp">I-manage ang mga user account, role at permission</div>
    </div>

    <!-- // MAIN PAGE CONTENT // -->
    <div class="main-content user-management-page">
        
        <!-- // TAB NAVIGATION // -->
        <!-- These buttons control which content section (Users, Roles, or Audit Log) is visible. -->
        <div class="tabs-container">
            <button class="tab-link active" data-tab="users">Users</button>
            <button class="tab-link" data-tab="roles">Roles</button>
            <button class="tab-link" data-tab="audit">Audit Log</button>
        </div>

        <!-- // TAB 1: USERS // -->
        <!-- This section is for managing individual user accounts. It's visible by default. -->
        <div id="users" class="tab-content active">
            <div class="content-card">
                <div class="tooltip-container">
                    <span class="tooltip-icon">?</span>
                    <div class="tooltip-message">
                        <p>Dito mo maaaring i-manage ang lahat ng user account, magdagdag ng bago, mag-edit ng detalye, at i-deactivate ang mga account.</p>
                        <p><em>Here you can manage all user accounts, add new users, edit details, and deactivate accounts.</em></p>
                    </div>
                </div>
                <div class="card-header">
                    <h2>User Accounts</h2>
                    <button id="addNewUserBtn" class="action-button">Add New User</button>
                </div>
                <div class="table-controls">
                    <input type="text" id="userSearchInput" class="filter-input" placeholder="Search by name, email, or ID...">
                </div>
                <div class="table-wrapper">
                    <table id="usersTable">
                        <thead>
                            <tr>
                                <th data-column="full_name" class="sortable">Full Name <span class="sort-icon"></span></th>
                                <th data-column="email" class="sortable">Email <span class="sort-icon"></span></th>
                                <th>Phone Number</th>
                                <th data-column="role_name" class="sortable">Role <span class="sort-icon"></span></th>
                                <th data-column="status" class="sortable">Status <span class="sort-icon"></span></th>
                                <th data-column="last_login" class="sortable">Last Login <span class="sort-icon"></span></th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
                <div class="pagination-controls">
                    <button id="userPrevPageBtn" disabled>Previous</button>
                    <span id="userPageInfo">Page 1 of 1</span>
                    <button id="userNextPageBtn" disabled>Next</button>
                </div>
            </div>
        </div>

        <!-- // TAB 2: ROLES // -->
        <!-- This section is for managing user roles (e.g., Admin, Technician). Hidden by default. -->
        <div id="roles" class="tab-content">
            <div class="content-card">
                <div class="tooltip-container">
                    <span class="tooltip-icon">?</span>
                    <div class="tooltip-message">
                        <p>Dito mo maaaring i-manage ang mga user role at ang kanilang mga permission. Magdagdag, mag-edit, o mag-delete ng role.</p>
                        <p><em>Here you can manage user roles and their permissions. Add, edit, or delete a role.</em></p>
                    </div>
                </div>
                <div class="card-header">
                    <h2>Roles</h2>
                    <button id="addNewRoleBtn" class="action-button">Add New Role</button>
                </div>
                <div class="table-wrapper">
                    <!-- Table to display all roles. The body is populated by JavaScript. -->
                    <table id="rolesTable">
                        <thead>
                            <tr>
                                <th>Role Name</th>
                                <th>Description</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Role rows are inserted here dynamically. -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- // TAB 3: AUDIT LOG // -->
        <!-- This section displays a log of all important system events. Hidden by default. -->
        <div id="audit" class="tab-content">
            <div class="content-card">
                <div class="tooltip-container">
                    <span class="tooltip-icon">?</span>
                    <div class="tooltip-message">
                        <p>Isang talaan ng lahat ng mahahalagang event at aksyon ng user sa system. Gamitin ang filter para maghanap ng partikular na log.</p>
                        <p><em>A record of all significant events and user actions in the system. Use the filters to search for specific logs.</em></p>
                    </div>
                </div>
                <div class="card-header">
                    <h2>System Audit Log</h2>
                    <div class="card-header-actions">
                        <button id="exportAuditCsvBtn" class="action-button small">Export as CSV</button>
                        <button id="exportAuditPdfBtn" class="action-button small">Export as PDF</button>
                    </div>
                </div>
                <div class="filters-container">
                    <input type="text" id="auditDateFilter" class="filter-input" placeholder="Filter by date range...">
                    <input type="text" id="auditUserFilter" class="filter-input" placeholder="Filter by user...">
                    <input type="text" id="auditActionFilter" class="filter-input" placeholder="Filter by event...">
                </div>
                <div class="table-wrapper">
                    <table id="auditLogTable">
                        <thead>
                            <tr>
                                <th data-column="timestamp" class="sortable">Timestamp <span class="sort-icon"></span></th>
                                <th data-column="user_name" class="sortable">User <span class="sort-icon"></span></th>
                                <th>Event Description</th>
                                <th data-column="status" class="sortable">Status <span class="sort-icon"></span></th>
                                <th data-column="ip_address" class="sortable">IP Address <span class="sort-icon"></span></th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
                <div class="pagination-controls">
                    <button id="auditPrevPageBtn" disabled>Previous</button>
                    <span id="auditPageInfo">Page 1 of 1</span>
                    <button id="auditNextPageBtn" disabled>Next</button>
                </div>
            </div>
        </div>
    </div>

    <!-- // MODALS (POP-UP DIALOGS) // -->
    <!-- These sections are hidden by default and shown by JavaScript. -->

    <!-- Modal 1: Add/Edit User -->
    <div id="userModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="userModalTitle">Add New User</h2>
                <button id="closeUserModalBtn" class="modal-close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <form id="userForm">
                    <input type="hidden" id="userId"> <!-- Hidden field to store the ID when editing a user. -->
                    <div class="form-group">
                        <label for="userFullName">Full Name</label>
                        <input type="text" id="userFullName" required>
                    </div>
                    <div class="form-group">
                        <label for="userEmail">Email</label>
                        <input type="email" id="userEmail" required>
                    </div>
                     <div class="form-group">
                        <label for="userPhoneNumber">Phone Number</label>
                        <input type="tel" id="userPhoneNumber" placeholder="+639XXXXXXXXX" pattern="\+639[0-9]{9}" maxlength="13" title="Phone number must be in the format +639XXXXXXXXX.">
                    </div>
                    <div class="form-group">
                        <label for="userRole">Role</label>
                        <select id="userRole" required>
                            <!-- Role options are loaded here by JavaScript. -->
                        </select>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="action-button">Save User</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal 2: Display New User Credentials -->
    <div id="newUserCredentialsModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="credentialsModalTitle">User Created Successfully</h2>
            </div>
            <div class="modal-body">
                <p>Please provide the following credentials to the new user. They should change their password upon first login.</p>
                <!-- This box displays the temporary password for a newly created user. -->
                <div class="credentials-box">
                    <p><strong>Name:</strong> <span id="newUserName"></span></p>
                    <p><strong>Email:</strong> <span id="newUserEmail"></span></p>
                    <p><strong>Phone Number:</strong> <span id="newPhoneNumber"></span></p>
                    <p><strong>Temporary Password:</strong> <strong id="newUserPassword"></strong></p>
                </div>
                <div class="form-actions">
                    <button id="closeCredentialsModalBtn" class="action-button">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal 3: Add/Edit Role -->
    <div id="roleModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="roleModalTitle">Add New Role</h2>
                <button id="closeRoleModalBtn" class="modal-close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <form id="roleForm">
                    <input type="hidden" id="roleId"> <!-- Hidden field to store the ID when editing a role. -->
                    <div class="form-group">
                        <label for="roleName">Role Name</label>
                        <input type="text" id="roleName" required>
                    </div>
                    <div class="form-group">
                        <label for="rolePermissions">Permissions / Description</label>
                        <textarea id="rolePermissions" rows="4"></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="action-button">Save Role</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal 4: Restricted Actions -->
    <div id="protectedRoleModal" class="modal-overlay">
        <div class="modal-content text-center">
            <div class="modal-header">
                <h2 id="protectedRoleModalTitle">
                    Hindi Pwedeng Baguhin<br>
                    <span class="english-translation">Modification Restricted</span>
                </h2>
                <button id="closeProtectedRoleModalBtn" class="modal-close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="modal-icon-svg">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                        <path d="M256 32c14.2 0 27.3 7.5 34.5 19.8l216 368c7.3 12.4 7.3 27.7 .2 40.1S486.3 480 472 480H40c-14.3 0-27.6-7.7-34.7-20.1s-7-27.8 .2-40.1l216-368C228.7 39.5 241.8 32 256 32zm0 128c-13.3 0-24 10.7-24 24V296c0 13.3 10.7 24 24 24s24-10.7 24-24V184c0-13.3-10.7-24-24-24zm32 224c0-17.7-14.3-32-32-32s-32 14.3-32 32s14.3 32 32 32s32-14.3 32-32z" fill="#f39c12"/>
                    </svg>
                </div>

                <p>
                    Isa itong core system role at hindi maaaring i-edit o i-delete.<br>
                    <span class="english-translation">
                        This is a core system role and cannot be edited or deleted. These roles are essential for the application's functionality.
                    </span>
                </p>
            </div>
        </div>
    </div>

    <!-- // MODAL for TOAST NOTIFICATIONS (SUCCESS/INFO) // -->
    <div id="toastModal" class="toast-modal">
        <div class="toast-content">
            <div id="toastIcon" class="toast-icon">
                <!-- SVG Icon will be inserted here by JavaScript -->
            </div>
            <p id="toastMessage" class="toast-message"></p>
        </div>
    </div>
    
    <div id="liveAlertBanner" class="live-alert-banner">
        <div class="live-alert-icon">🔔</div>
        <div class="live-alert-content">
            <p id="liveAlertTitle" class="live-alert-title">New Alert</p>
            <p id="liveAlertDetails" class="live-alert-details">Details of the alert...</p>
        </div>
        <div id="liveAlertActions" class="live-alert-actions">
            <button id="snoozeLiveAlertBtn">Snooze</button>
            <button id="ackLiveAlertBtn">Acknowledge</button>
        </div>
        <button id="closeLiveAlertBtn" class="close-live-alert-btn">&times;</button>
    </div>

    <div id="networkStatusBanner" class="network-status-banner">
        <span id="networkStatusIcon">⚠️</span>
        <span id="networkStatusText">No network connection. Displayed data may not be live.</span>
    </div>
    
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script src="{{ url_for('static', filename='global_alerter.js') }}"></script>
    
    <!-- // JAVASCRIPT LIBRARIES & SCRIPTS // -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <!-- The main JavaScript file for this page's functionality. -->
    <script src="{{ url_for('static', filename='user_management.js') }}"></script>
</body>
</html>
